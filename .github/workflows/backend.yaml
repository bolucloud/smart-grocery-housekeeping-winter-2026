name: Build and Deploy FastAPI backend to AWS

on:
  push:
    branches:
    - main
    paths:
    - 'backend/**'
    - 'infrastructure/**'
    - '.github/workflows/backend**'
  pull_request:
    branches:
    - main
    types: [ opened, synchronize, reopened ]
    paths:
    - 'backend/**'
    - 'infrastructure/**'
    - '.github/workflows/backend**'

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: smart-grocery-housekeeping
  ECS_SERVICE: smart-grocery-housekeeping-backend-service
  ECS_CLUSTER: smart-grocery-housekeeping-ecs-cluster
  ECS_TASK_DEFINITION: infrastructure/backend_taskdef.json
  CONTAINER_NAME: fastapi-backend
  DOCKERFILE_PATH: ./Dockerfile
  DOCKER_CONTEXT: default

jobs:
  ##### COMPLETE THIS WHEN JOHN GIVES ME THE TESTS TO RUN #####
  fastapi_and_python_tests:
    runs-on: self-hosted
    # if: github.event_name == 'pull_request'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
        pip install pytest pytest-asyncio pytest-cov httpx pydantic 'pydantic[email]' fastapi

    - name: Run tests
      run: |
        pytest --cov=backend backend/tests/

  build-image-and-deploy:
    if: github.event.pull_request.merged == true
    runs-on: self-hosted
    # needs: fastapi_and_python_tests
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Clean Docker context
      run: |
        # Remove problematic Docker context
        rm -rf ~/.docker/contexts
        # Reset to default context
        docker context use default

    - name: Login to AWS ECR
      id: login-ecr-bash
      run: |
        aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 480428003157.dkr.ecr.us-east-1.amazonaws.com

    # - name: Login to AWS ECR
    #   id: login-ecr
    #   uses: aws-actions/amazon-ecr-login@v2
    #   with:
    #     mask-password: true


    # - name: Setup Docker Buildx
    #   uses: docker/setup-buildx-action@v3

    - name: Build docker image
      id: build-image
      run: |
        cp backend/requirements.txt .  # Copy requirements.txt to root for Docker build context
        ECR_REPO_URI="480428003157.dkr.ecr.us-east-1.amazonaws.com/smart-grocery-housekeeping"
        MAJOR_MINOR_VERSION="1.0"
        BUILD_NUMBER=${GITHUB_RUN_NUMBER}
        VERSION="${MAJOR_MINOR_VERSION}-${BUILD_NUMBER}"
        docker build --platform linux/amd64 -t ${ECR_REPO_URI}:$VERSION -t ${ECR_REPO_URI}:latest -f backend/Dockerfile .

    - name: Push docker image to ECR
      id: push-to-ecr
      run: |
        ECR_REPO_URI="480428003157.dkr.ecr.us-east-1.amazonaws.com/smart-grocery-housekeeping"
        MAJOR_MINOR_VERSION="1.0"
        BUILD_NUMBER=${GITHUB_RUN_NUMBER}
        VERSION="${MAJOR_MINOR_VERSION}-${BUILD_NUMBER}"

        docker push ${ECR_REPO_URI}:$VERSION
        docker push ${ECR_REPO_URI}:latest
        echo "ecr_image_uri=${ECR_REPO_URI}:$VERSION" >> $GITHUB_OUTPUT

    - name: Force New ECS on new image build
      run: |
        # Force new deployment with existing task definition
        aws ecs update-service \
          --cluster ${ECS_CLUSTER} \
          --service ${ECS_SERVICE} \
          --force-new-deployment \
          --region ${AWS_REGION}
